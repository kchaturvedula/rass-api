name: RASS API Proxmox Container Management

on:
  push:     # Updates existing containers
  create:   # Creates containers for new branches  
  delete:   # Removes containers when branches are deleted

jobs:
  setup-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y sshpass jq

      - uses: maxklema/proxmox-launchpad@v0.0.7
        with:
          proxmox_username: ${{ secrets.PROXMOX_USERNAME }}
          proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}
          github_pat: ${{ secrets.GH_PAT }}

  manage-container:
    runs-on: self-hosted
    needs: setup-runner
    steps:
      - uses: maxklema/proxmox-launchpad@v0.0.7
        with:
          proxmox_username: ${{ secrets.PROXMOX_USERNAME }}
          proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}
          github_pat: ${{ secrets.GH_PAT }}
          # Container settings
          http_port: 3000
          linux_distribution: debian
          public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          # Application deployment
          install_command: "npm install"
          build_command: "npm run build"
          start_command: "npm start"
          runtime_language: "nodejs"
          # Environment variables - Added HOST=0.0.0.0 for external access
          container_env_vars: '{"NODE_ENV": "production", "PORT": "3000", "HOST": "0.0.0.0"}'
